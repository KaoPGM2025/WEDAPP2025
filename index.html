<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Piggyverse Cloud Pocket - Sparkle Wallet Theme</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&family=Inter:wght@500;700&display=swap');
body {
    font-family: 'Inter', 'Prompt', sans-serif;
    background: linear-gradient(135deg, #0e1647 0%, #7f53ac 35%, #43e97b 100%);
    min-height: 100vh;
    margin: 0;
    color: #fafffa;
    letter-spacing: 0.01em;
}
.theme-version {
    position: fixed;
    top: 10px;
    right: 18px;
    color: #fff;
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 50%,#7f53ac 100%);
    padding: 5px 18px 5px 12px;
    border-radius: 18px;
    font-size: 1em;
    font-family: 'Prompt', 'Inter', sans-serif;
    font-weight: 700;
    box-shadow: 0 2px 18px #43e97b80;
    z-index: 30;
    letter-spacing: 0.08em;
    border: 1.5px solid #7f53ac;
    user-select: none;
}
.container {
    max-width: 540px;
    margin: 4vh auto;
    background: rgba(24, 18, 87, 0.97);
    border-radius: 28px;
    box-shadow: 0 8px 48px 0 rgba(127, 83, 172, 0.10);
    padding: 36px 22px;
    position: relative;
    overflow: hidden;
    border: 2.2px solid #43e97b;
}
.menu-bar {
    display: flex;
    gap: 0;
    margin-bottom: 20px;
    background: rgba(67, 233, 123, 0.13);
    border-radius: 14px;
    padding: 6px 6px 6px 6px;
    box-shadow: 0 2px 8px 0 rgba(67, 233, 123, 0.10);
    overflow-x: unset;
}
.menu-bar button {
    border: none;
    background: transparent;
    color: #43e97b;
    padding: 10px 0;
    border-radius: 0;
    font-weight: 700;
    font-family: 'Inter', 'Prompt', sans-serif;
    font-size: 1.08em;
    min-width: 114px;
    max-width: 180px;
    height: 44px;
    cursor: pointer;
    transition: background 0.18s, color 0.17s;
    outline: none;
    border-right: 1.5px solid #7f53ac44;
    border-left: none;
    margin: 0;
    letter-spacing: 0.02em;
    flex: 1 0 0px;
    display: inline-block;
    text-align: center;
    box-sizing: border-box;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.menu-bar button span {
    display: block;
    width: 100%;
    font-family: 'Inter', 'Prompt', sans-serif;
    font-weight: 700;
    font-size: 1.03em;
    letter-spacing: 0.01em;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
}
.menu-bar button:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
    border-left: none !important;
}
.menu-bar button:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
    border-right: none;
}
.menu-bar button.active, .menu-bar button.online {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 60%,#7f53ac 100%);
    color: #0e1647;
    box-shadow: 0 2px 8px #38f9d755;
    z-index: 2;
}
.menu-bar button.offline {
    background: #2b6e7a;
    color: #43e97b;
}
.menu-bar button#logout-btn {
    background: #38f9d7;
    color: #0e1647;
    min-width: 114px;
    font-weight: 700;
    z-index: 2;
    border-radius: 0 12px 12px 0;
    border-right: none;
}
@media (max-width: 640px) {
    .menu-bar button {
        font-size: 1em;
        min-width: 80px;
        padding: 9px 0;
        height: 38px;
        max-width: 140px;
    }
    .menu-bar button span {
        font-size: 1em;
    }
}
@media (max-width: 500px) {
    .container { max-width: 99vw; padding: 15px 1vw; }
    .modal form { min-width: 0; max-width: 99vw; }
    .pocket-card { min-width: 0; max-width: 99vw; }
    .menu-bar { padding: 3px 1px 3px 1px; }
}
#graph-switch {
    display: flex;
    gap: 10px;
    margin-bottom: 11px;
}
#graph-switch button {
    background: #231d4f;
    color: #43e97b;
    border: 1.5px solid #43e97b;
    font-weight: 700;
    border-radius: 8px;
    font-size: 1em;
    padding: 6px 16px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
}
#graph-switch button.active {
    background: linear-gradient(90deg,#43e97b 0%,#7f53ac 100%);
    color: #17113a;
}
#welcome-user {
    font-size: 1.12em;
    font-weight: bold;
    color: #43e97b;
    margin-bottom: 18px;
    letter-spacing: 0.01em;
}
#pockets-list {
    display: flex;
    flex-direction: column;
    gap: 18px;
    margin-top: 20px;
}
.pocket-card {
    background: linear-gradient(90deg,#43e97b 60%,#38f9d7 90%,#7f53ac 100%);
    border-radius: 20px;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 16px 0 rgba(67, 233, 123, 0.14);
    border: 1.7px solid #43e97b;
    position: relative;
    min-width: 220px;
    max-width: 420px;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
}
.pocket-profile {
    font-size: 2.5rem;
    border-radius: 50%;
    border: 3px solid #fff;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg,#7f53ac 10%,#43e97b 100%);
    color: #fff;
    box-shadow: 0 1px 8px #43e97b38;
}
.pocket-info {
    flex: 1;
    min-width: 0;
}
.pocket-name {
    font-size: 1.14rem;
    font-weight: bold;
    color: #0e1647;
    text-shadow: 0 1px 4px #7f53ac55;
    margin-bottom: 2px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}
.pocket-meta {
    font-size: 1rem;
    color: #17113a;
    margin-bottom: 6px;
}
.progress-bar-bg {
    background: #16315c;
    border-radius: 8px;
    height: 16px;
    margin-top: 7px;
    width: 100%;
    overflow: hidden;
    box-shadow: 0 0.5px 3px #38f9d780 inset;
}
.progress-bar {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 60%,#7f53ac 100%);
    height: 16px;
    border-radius: 8px;
    width: 0%;
    transition: width 0.6s, background 0.5s;
}
.progress-bar.just-saved {
    background: linear-gradient(90deg,#fff 0%,#43e97b 100%);
}
.pocket-actions {
    display: flex;
    gap: 7px;
    margin-top: 6px;
}
.pocket-actions input[type="number"] {
    width: 65px;
    padding: 7px;
    border-radius: 7px;
    font-size: 1em;
    border: 1px solid #43e97b;
    background: #1a1c3e;
    color: #43e97b;
    outline: none;
}
.pocket-actions button {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
    color: #0e1647;
    border: none;
    border-radius: 7px;
    padding: 5px 13px;
    font-size: 1em;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.18s;
}
.pocket-actions button[disabled] {
    background: #2b6e7a;
    color: #43e97b;
    cursor: not-allowed;
}
.pocket-actions button:last-child {
    background: #7f53ac;
    color: #fff;
}
#add-pocket-btn {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
    color: #0e1647;
    border-radius: 13px;
    border: none;
    padding: 9px 18px;
    margin-bottom: 10px;
    font-size: 1em;
    font-family: inherit;
    font-weight: 700;
    letter-spacing: 0.05em;
    box-shadow: 0 1px 8px #43e97b38;
    cursor: pointer;
}
#add-pocket-btn:hover {
    opacity: 0.92;
}
.modal {
    display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
    background:rgba(67,233,123,0.13);
    align-items:center; justify-content:center; z-index:20;
}
.modal[style*="display: flex"] {
    display: flex !important;
}
.modal form {
    background:#181a2f;
    border-radius:20px;
    box-shadow:0 3px 16px #43e97b90;
    padding:28px 22px;
    display:flex; flex-direction:column; gap:13px; min-width:250px;
    border: 1px solid #38f9d7;
    color: #43e97b;
    max-width: 96vw;
    margin: auto;
}
.modal form label {
    font-size: 1em;
    margin-bottom: 2px;
}
#profile-choices {
    display: flex; gap: 10px; margin:8px 0 5px 0;
}
#profile-choices span {
    width: 46px; height: 46px; border-radius:50%;
    border: 3px solid #43e97b;
    background: linear-gradient(135deg,#7f53ac 60%,#43e97b80 100%);
    font-size:2.2rem; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition: border 0.15s, background 0.15s;
}
#profile-choices .selected {
    border:3px solid #38f9d7;
    background: linear-gradient(135deg,#43e97b 40%,#7f53ac 100%);
    color: #fff;
}
#graph-view, #history-view {
    background: linear-gradient(90deg,#1a1c3e 60%,#38f9d720 100%);
    border-radius: 18px;
    padding: 18px 14px;
    box-shadow: 0 1px 10px #43e97b12;
}
#history-list { padding-left: 0; }
#history-list li {
    margin-bottom: 8px;
    font-size: 1rem;
    color: #43e97b;
}
#clear-history-btn {
    margin-bottom: 10px;
    background: #38f9d7;
    color: #0e1647;
    border: none;
    border-radius: 10px;
    padding: 7px 16px;
    font-size: 1em;
    font-family: inherit;
    font-weight: 600;
    letter-spacing: 0.02em;
    cursor: pointer;
    box-shadow: 0 1px 6px #43e97b30;
}
.auth-forms form { display: none; flex-direction: column; gap: 15px; }
.auth-forms form.active { display: flex; }
input[type="text"], input[type="password"], input[type="number"] {
    padding: 13px 15px;
    border-radius: 11px;
    border: 1.5px solid #43e97b;
    background: #1a1c3e;
    color: #43e97b;
    font-size: 1em;
    outline: none;
}
input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus {
    border-color: #38f9d7;
}
input[type="number"]::-webkit-inner-spin-button { appearance: none; }
button[type="submit"] {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
    color: #0e1647;
    padding: 11px 0;
    border: none;
    border-radius: 13px;
    font-weight: 700;
    font-size: 1em;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.16s;
    font-family: inherit;
    letter-spacing: 0.03em;
}
button[type="submit"]:hover { opacity: 0.93; }
.switch-link {
    color: #38f9d7;
    cursor: pointer;
    font-size: 0.96em;
    text-align: right;
    margin-top: 3px;
}
.message {
    min-height: 18px;
    font-size: 1em;
    color: #43e97b;
}
</style>
</head>
<body>
<div class="theme-version">Sparkle Wallet Theme (Piggyverse)</div>
<!-- Auth section -->
<div class="container" id="auth-section">
    <div class="auth-forms">
        <form id="login-form" class="active">
            <h2>Sign In</h2>
            <input type="text" id="login-username" placeholder="Username" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Sign In</button>
            <span class="switch-link" onclick="switchForm('register-form')">Don't have an account? Register</span>
            <div class="message" id="login-message"></div>
        </form>
        <form id="register-form">
            <h2>Register</h2>
            <input type="text" id="register-username" placeholder="Username" required>
            <input type="password" id="register-password" placeholder="Password" required>
            <input type="password" id="register-password2" placeholder="Confirm Password" required>
            <button type="submit">Register</button>
            <span class="switch-link" onclick="switchForm('login-form')">Already have an account? Sign In</span>
            <div class="message" id="register-message"></div>
        </form>
    </div>
</div>

<!-- Piggyverse App Section -->
<div class="container" id="app-section" style="display:none;">
    <nav class="menu-bar">
        <button id="menu-home" class="active"><span>Home</span></button>
        <button id="menu-graph"><span>Graph</span></button>
        <button id="menu-history"><span>History</span></button>
        <button id="toggle-online" class="online"><span>Online</span></button>
        <button id="logout-btn"><span>Logout</span></button>
    </nav>
    <section id="home-view">
        <div id="welcome-user"></div>
        <button id="add-pocket-btn">+ Add Cloud Pocket</button>
        <div id="pockets-list"></div>
    </section>
    <div class="modal" id="pocket-modal">
        <form id="pocket-form">
            <h3>Add Cloud Pocket</h3>
            <label>Pocket Name <input type="text" id="pocket-name" required></label>
            <label>Profile
                <div id="profile-choices"></div>
            </label>
            <label>Savings Type
                <select id="saving-type">
                    <option value="General">General</option>
                    <option value="Daily">Daily</option>
                    <option value="Monthly">Monthly</option>
                </select>
            </label>
            <label>Goal Amount <input type="number" id="goal-amount" min="1" required></label>
            <button type="submit">Save</button>
            <button type="button" id="cancel-pocket">Cancel</button>
        </form>
    </div>
    <!-- Graph View -->
    <section id="graph-view" style="display:none;">
        <h2>Savings Graph</h2>
        <div id="graph-switch">
            <button id="graph-daily" class="active">Daily</button>
            <button id="graph-monthly">Monthly</button>
        </div>
        <canvas id="saving-graph" width="350" height="200"></canvas>
    </section>
    <!-- History View -->
    <section id="history-view" style="display:none;">
        <h2>Savings History</h2>
        <ul id="history-list"></ul>
    </section>
</div>
<script>
const USER_KEY = 'neoverse_users';
const SESSION_KEY = 'neoverse_session';

function getUsers() {
    try { return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }
    catch { return {}; }
}
function setUsers(users) {
    localStorage.setItem(USER_KEY, JSON.stringify(users));
}
function getSession() {
    return localStorage.getItem(SESSION_KEY);
}
function setSession(username) {
    if (username) localStorage.setItem(SESSION_KEY, username);
    else localStorage.removeItem(SESSION_KEY);
}
function switchForm(formId) {
    document.querySelectorAll('.auth-forms form').forEach(f => f.classList.remove('active'));
    document.getElementById(formId).classList.add('active');
    document.getElementById('login-message').textContent = '';
    document.getElementById('register-message').textContent = '';
}
document.getElementById('register-form').onsubmit = function (e) {
    e.preventDefault();
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value;
    const password2 = document.getElementById('register-password2').value;
    const msg = document.getElementById('register-message');
    let users = getUsers();
    if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
        msg.textContent = "Username must be 3-20 characters (a-z, 0-9, _)";
        return;
    }
    if (users[username]) {
        msg.textContent = "This username is already taken";
        return;
    }
    if (password.length < 6) {
        msg.textContent = "Password must be at least 6 characters";
        return;
    }
    if (password !== password2) {
        msg.textContent = "Passwords do not match";
        return;
    }
    users[username] = { password: password, pockets: [], history: [] };
    setUsers(users);
    msg.textContent = "Registration successful! Please sign in.";
    setTimeout(() => switchForm('login-form'), 900);
};
document.getElementById('login-form').onsubmit = function (e) {
    e.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    const msg = document.getElementById('login-message');
    let users = getUsers();
    if (!users[username] || users[username].password !== password) {
        msg.textContent = "Incorrect username or password";
        return;
    }
    setSession(username);
    showApp();
};
document.getElementById('logout-btn').onclick = function () {
    setSession(null);
    showAuth();
};
const piggyProfiles = [
    {id: 1, img: "🐷"},
    {id: 2, img: "🦄"},
    {id: 3, img: "🍭"},
    {id: 4, img: "🌈"},
    {id: 5, img: "🐻"}
];
let isOnline = true;
let selectedProfileId = 1;

function renderProfileChoices(selectedId = 1) {
    selectedProfileId = selectedId;
    const pc = document.getElementById('profile-choices');
    pc.innerHTML = '';
    piggyProfiles.forEach(p => {
        let el = document.createElement('span');
        el.innerHTML = p.img;
        el.className = p.id === selectedProfileId ? 'selected' : '';
        el.dataset.id = p.id;
        el.tabIndex = 0;
        el.setAttribute('role', 'button');
        el.setAttribute('aria-label', 'Select profile');
        el.onclick = function() {
            renderProfileChoices(p.id);
        };
        el.onkeydown = function(e) {
            if (e.key === "Enter" || e.key === " ") renderProfileChoices(p.id);
        };
        pc.appendChild(el);
    });
}

function getPockets() {
    const user = getSession();
    let users = getUsers();
    return (users[user] && users[user].pockets) || [];
}
function savePockets(pockets) {
    const user = getSession();
    let users = getUsers();
    users[user].pockets = pockets;
    setUsers(users);
}

function renderPockets() {
    const pockets = getPockets();
    const list = document.getElementById('pockets-list');
    list.innerHTML = '';
    if (!pockets.length) {
        list.innerHTML = '<div style="color:#999;text-align:center;margin:20px 0;">No Cloud Pocket yet</div>';
        return;
    }
    pockets.forEach((pocket, idx) => {
        let card = document.createElement('div');
        card.className = 'pocket-card';
        let profile = piggyProfiles.find(p => p.id === pocket.profile) || piggyProfiles[0];
        let isJustSaved = pocket._justSaved;
        card.innerHTML = `
            <div class="pocket-profile">${profile.img}</div>
            <div class="pocket-info">
                <div class="pocket-name">${pocket.name}</div>
                <div class="pocket-meta">${pocket.type} | Goal: ${pocket.goal} ฿ | Saved: ${pocket.saved || 0} ฿</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar${isJustSaved?' just-saved':''}" style="width:${Math.min(100, Math.round((pocket.saved||0)/pocket.goal*100))}%"></div>
                </div>
            </div>
            <div class="pocket-actions">
                <input type="number" min="1" placeholder="Save..." style="width:65px;" ${isOnline?'':'disabled'}>
                <button ${isOnline?'':'disabled'}>Save</button>
                <button style="background:#7f53ac;color:#fff;" ${isOnline?'':'disabled'}>Delete</button>
            </div>
        `;
        // Deposit
        card.querySelector('button').onclick = function() {
            if (!isOnline) return;
            let val = parseInt(card.querySelector('input[type="number"]').value);
            if (!val || val < 1) return;
            if ((pocket.saved||0) + val > pocket.goal) val = pocket.goal - (pocket.saved||0);
            pocket.saved = (pocket.saved||0) + val;
            pocket._justSaved = true;
            savePockets(pockets);
            addHistory(pocket, val);
            renderPockets();
            setTimeout(()=>{
                delete pocket._justSaved;
                savePockets(pockets);
                renderPockets();
            }, 900);
        };
        // Remove
        card.querySelectorAll('button')[1].onclick = function() {
            if (!isOnline) return;
            if (confirm('Delete this Cloud Pocket?')) {
                pockets.splice(idx, 1);
                savePockets(pockets);
                renderPockets();
            }
        };
        list.appendChild(card);
    });
}

function showPocketModal(editIdx = null) {
    document.getElementById('pocket-modal').style.display = 'flex';
    selectedProfileId = 1;
    renderProfileChoices(selectedProfileId);
    document.getElementById('pocket-form').reset();
}
function hidePocketModal() {
    document.getElementById('pocket-modal').style.display = 'none';
}

document.getElementById('add-pocket-btn').onclick = () => showPocketModal();
document.getElementById('cancel-pocket').onclick = hidePocketModal;
document.getElementById('pocket-form').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('pocket-name').value.trim();
    const goal = parseInt(document.getElementById('goal-amount').value);
    const type = document.getElementById('saving-type').value;
    const profileId = selectedProfileId;
    let pockets = getPockets();
    if (!name || !goal || goal < 1) return;
    pockets.push({name, goal, type, profile: profileId, saved: 0});
    savePockets(pockets);
    hidePocketModal();
    renderPockets();
};

['home','graph','history'].forEach(view=>{
    document.getElementById(`menu-${view}`).onclick = () => {
        ['home','graph','history'].forEach(v=>{
            document.getElementById(`menu-${v}`).classList.remove('active');
            document.getElementById(`${v}-view`).style.display = v===view?'':'none';
        });
        document.getElementById(`menu-${view}`).classList.add('active');
        if (view==='graph') renderGraph();
        if (view==='history') renderHistory();
    };
});
document.getElementById('toggle-online').onclick = function() {
    isOnline = !isOnline;
    this.className = isOnline ? 'online' : 'offline';
    this.innerHTML = isOnline ? '<span>Online</span>' : '<span>Offline</span>';
    renderPockets();
};

function getHistory() {
    const user = getSession();
    let users = getUsers();
    return (users[user] && users[user].history) || [];
}
function saveHistory(history) {
    const user = getSession();
    let users = getUsers();
    users[user].history = history;
    setUsers(users);
}
function addHistory(pocket, amount) {
    let h = getHistory();
    h.unshift({date: new Date().toISOString(), name: pocket.name, amount, currency: 'THB'});
    saveHistory(h);
}
function renderHistory() {
    const list = document.getElementById('history-list');
    const h = getHistory();
    if (!document.getElementById('clear-history-btn')) {
        const btn = document.createElement('button');
        btn.textContent = "🗑️ Clear All History";
        btn.id = "clear-history-btn";
        btn.className = "clear-history-btn";
        btn.onclick = function() {
            if (confirm('Clear all savings history?')) {
                saveHistory([]);
                renderHistory();
            }
        };
        document.getElementById('history-view').insertBefore(btn, list);
    }
    if (!h.length) { list.innerHTML = '<li>No savings history yet</li>'; return; }
    list.innerHTML = '';
    h.forEach(item=>{
        let li = document.createElement('li');
        li.textContent = `[${item.date.split('T')[0]}] ${item.name} +${item.amount} ฿`;
        list.appendChild(li);
    });
}

let graphMode = "daily";
document.getElementById("graph-daily").onclick = function() {
    graphMode = "daily";
    this.classList.add("active");
    document.getElementById("graph-monthly").classList.remove("active");
    renderGraph();
};
document.getElementById("graph-monthly").onclick = function() {
    graphMode = "monthly";
    this.classList.add("active");
    document.getElementById("graph-daily").classList.remove("active");
    renderGraph();
};
function renderGraph() {
    const c = document.getElementById('saving-graph');
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const history = getHistory();
    if (!history.length) {
        ctx.fillStyle = "#43e97b";
        ctx.font = "16px Inter,Prompt,sans-serif";
        ctx.fillText("No savings data", 60, 110);
        return;
    }
    let dataMap = {}, keys = [];
    if (graphMode==="daily") {
        history.forEach(item => {
            const amt = parseInt(item.amount);
            if (!amt || amt < 1) return;
            const dstr = item.date ? item.date.split("T")[0] : "";
            if (!dstr) return;
            dataMap[dstr] = (dataMap[dstr]||0) + amt;
        });
        keys = Object.keys(dataMap).sort();
    } else if (graphMode==="monthly") {
        history.forEach(item => {
            const amt = parseInt(item.amount);
            if (!amt || amt < 1) return;
            const d = new Date(item.date);
            const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,"0")}`;
            dataMap[key] = (dataMap[key]||0) + amt;
        });
        keys = Object.keys(dataMap).sort();
    }
    if (!keys.length) {
        ctx.fillStyle = "#43e97b";
        ctx.font = "16px Inter,Prompt,sans-serif";
        ctx.fillText("No savings data", 60, 110);
        return;
    }
    let barW = 18, gap = 10, maxY = 150, startX = 38, baseY = 180;
    if(keys.length>13) { barW = Math.max(8, 260/keys.length); gap = 4; }
    const maxSum = Math.max(...Object.values(dataMap));
    keys.forEach((k, i) => {
        const sum = dataMap[k];
        const h = Math.round((sum/maxSum) * maxY);
        const x = startX + i*(barW+gap);
        ctx.fillStyle = "#43e97b";
        ctx.fillRect(x, baseY-h, barW, h);
        ctx.fillStyle = "#0e1647";
        ctx.font = "bold 12px Inter,Prompt,sans-serif";
        ctx.fillText(sum+" ฿", x, baseY-h-6);
        ctx.save();
        ctx.translate(x+barW/2, baseY+13);
        ctx.rotate(-Math.PI/6);
        ctx.textAlign = "center";
        ctx.font = "11px Prompt,sans-serif";
        ctx.fillStyle = "#7f53ac";
        ctx.fillText(k, 0, 0);
        ctx.restore();
    });
    ctx.strokeStyle = "#43e97b";
    ctx.beginPath();
    ctx.moveTo(startX-10, baseY-maxY);
    ctx.lineTo(startX-10, baseY+2);
    ctx.stroke();
    ctx.font = "12px Inter,Prompt,sans-serif";
    ctx.fillStyle = "#43e97b";
    ctx.fillText(maxSum+" ฿", 2, baseY-maxY+8);
    ctx.fillText("0", 12, baseY+2);
}
function showWelcome() {
    const username = getSession();
    let el = document.getElementById('welcome-user');
    if (el) {
        el.textContent = `Welcome, ${username}! 👋`;
    }
}
function showApp() {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('app-section').style.display = '';
    showWelcome();
    renderPockets();
}
function showAuth() {
    document.getElementById('auth-section').style.display = '';
    document.getElementById('app-section').style.display = 'none';
    switchForm('login-form');
}
window.onload = function () {
    if (getSession() && getUsers()[getSession()]) showApp();
    else showAuth();
};
</script>
</body>
</html>
